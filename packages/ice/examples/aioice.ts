import WS from "ws";
import { Connection, Candidate } from "../src";

const WEBSOCKET_URI = "ws://127.0.0.1:8765";

// answer first
(async () => {
  const connection = new Connection(false, {
    stunServer: ["stun.l.google.com", 19302],
  });
  await connection.gatherCandidates();

  const ws = new WS(WEBSOCKET_URI);
  await new Promise((r) => ws.once("open", r));

  const message: string = await new Promise((r) =>
    ws.once("message", (data) => r(data as any))
  );
  console.log("received offer", message);
  const { candidates, username, password } = JSON.parse(message);
  connection.remoteCandidates = candidates.map((v: string) =>
    Candidate.fromSdp(v)
  );
  connection.remoteUsername = username;
  connection.remotePassword = password;

  ws.send(
    JSON.stringify({
      candidates: connection.localCandidates.map((v) => v.toSdp()),
      password: connection.localPassword,
      username: connection.localUserName,
    })
  );

  await new Promise((r) => {
    ws.once("close", r);
    ws.close();
  });

  connection.connect();
  console.log("connected");

  const [data, component] = await connection.onData.asPromise();
  console.log(`echoing ${data.toString()} on component ${component}`);
  await connection.send(Buffer.from("ice tea"));

  await new Promise((r) => setTimeout(r, 5000));
  await connection.close();
  console.log("closed");
  process.exit();
})();
